<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>CMR Ops</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:20px; color:#222}
    h1{margin:0 0 16px}
    .row{display:flex; gap:16px; flex-wrap:wrap; margin-bottom:12px}
    .card{border:1px solid #e5e7eb; border-radius:12px; padding:14px; background:#fff; max-width:760px}
    label{font-size:12px; color:#555; display:block; margin-bottom:6px}
    input,button{padding:8px; border-radius:8px; border:1px solid #d1d5db}
    button{cursor:pointer}
    pre{background:#f9fafb; border:1px solid #eee; border-radius:8px; padding:10px; overflow:auto}
    .muted{color:#666; font-size:12px}
    .actions{display:flex; gap:8px; align-items:end}
  </style>
</head>
<body>
  <h1>CMR Ops</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Base URL</label>
        <input id="baseUrl" placeholder="http://localhost:3000" style="width:260px">
      </div>
      <div>
        <label>API Key</label>
        <input id="apiKey" placeholder="x-api-key" style="width:220px">
      </div>
      <div class="actions">
        <button id="btnPing">Probar /health</button>
        <span id="pingOut" class="muted"></span>
      </div>
    </div>
    <div class="muted">Se guardan en localStorage.</div>
  </div>

  <div class="card">
    <h3>Inventario</h3>
    <div class="row">
      <div class="actions">
        <button id="btnRelease">Liberar reservas vencidas</button>
      </div>
    </div>
    <pre id="out">{}</pre>
  </div>

  <script>
    const K_API="cmr_api_key", K_BASE="cmr_base_url";
    function el(id){ return document.getElementById(id); }
    function base(){ return (el('baseUrl').value || 'http://localhost:3000').replace(/\/+$/,''); }
    function headers(){
      const h={'Content-Type':'application/json'};
      const key=(el('apiKey').value||'').trim();
      if(key) h['x-api-key']=key;
      return h;
    }
    async function get(path){
      const res = await fetch(base()+path,{headers:headers()});
      if(!res.ok){ throw new Error(res.status+' '+res.statusText+': '+(await res.text())); }
      return res.json();
    }
    async function post(path, body){
      const res = await fetch(base()+path,{method:'POST', headers:headers(), body: body?JSON.stringify(body):undefined});
      if(!res.ok){ throw new Error(res.status+' '+res.statusText+': '+(await res.text())); }
      return res.json();
    }
    function show(obj){ el('out').textContent = JSON.stringify(obj, null, 2); }

    document.addEventListener('DOMContentLoaded', ()=>{
      el('apiKey').value = localStorage.getItem(K_API)||'';
      el('baseUrl').value = localStorage.getItem(K_BASE)||'http://localhost:3000';
      el('apiKey').addEventListener('input', ()=>localStorage.setItem(K_API, el('apiKey').value));
      el('baseUrl').addEventListener('input', ()=>localStorage.setItem(K_BASE, el('baseUrl').value));
    });

    el('btnPing').onclick = async ()=>{
      el('pingOut').textContent = '...';
      try { const j = await get('/health'); el('pingOut').textContent='OK '+j.time; }
      catch(e){ el('pingOut').textContent='ERROR '+e.message; }
    };

    el('btnRelease').onclick = async ()=>{
      show({running:true});
      try {
        const j = await post('/inventory/release-expired');
        show(j);
      } catch(e){
        show({error:String(e)});
      }
    };
  </script>
</body>
</html>

  <div class="card" style="margin-top:16px">
    <h3>Producción</h3>
    <div class="row">
      <div>
        <label>SKU PT</label>
        <input id="prodSku" placeholder="PT-CAPRESE-001" style="width:220px">
      </div>
      <div>
        <label>Cantidad</label>
        <input id="prodQty" type="number" min="1" value="1" style="width:120px">
      </div>
      <div class="actions">
        <button id="btnProduce">Producir</button>
      </div>
    </div>
    <pre id="prodOut">{}</pre>
  </div>

  <script>
    (function(){
      function el(id){ return document.getElementById(id); }
      function base(){ return (el('baseUrl').value || 'http://localhost:3000').replace(/\/+$/,''); }
      function headers(){
        const h={'Content-Type':'application/json'};
        const key=(el('apiKey').value||'').trim();
        if(key) h['x-api-key']=key;
        return h;
      }
      async function post(path, body){
        const res = await fetch(base()+path,{method:'POST', headers:headers(), body: JSON.stringify(body||{})});
        const txt = await res.text();
        let j; try{ j = JSON.parse(txt); }catch{ j = { raw: txt }; }
        if(!res.ok){ throw new Error(JSON.stringify(j)); }
        return j;
      }
      function show(obj){ el('prodOut').textContent = JSON.stringify(obj, null, 2); }

      document.addEventListener('DOMContentLoaded', ()=>{
        const sku = el('prodSku'); const qty = el('prodQty');
        if (!sku.value) sku.value = localStorage.getItem('cmr_last_pt') || 'PT-CAPRESE-001';
        el('btnProduce').addEventListener('click', async ()=>{
          show({running:true});
          try {
            localStorage.setItem('cmr_last_pt', sku.value);
            const j = await post('/ops/produce', { sku: sku.value.trim(), qty: Number(qty.value||0) });
            show(j);
          } catch(e){
            show({error:String(e.message||e)});
          }
        });
      });
    })();
  </script>

  <div class="card" style="margin-top:16px">
    <h3>Producción</h3>
    <div class="row">
      <div>
        <label>SKU PT</label>
        <input id="prodSku" placeholder="PT-CAPRESE-001" style="width:220px">
      </div>
      <div>
        <label>Cantidad</label>
        <input id="prodQty" type="number" min="1" value="1" style="width:120px">
      </div>
      <div class="actions">
        <button id="btnProduce">Producir</button>
      </div>
    </div>
    <pre id="prodOut">{}</pre>
  </div>

  <script>
    (function(){
      function el(id){ return document.getElementById(id); }
      function base(){ return (el('baseUrl').value || 'http://localhost:3000').replace(/\/+$/,''); }
      function headers(){
        const h={'Content-Type':'application/json'};
        const key=(el('apiKey').value||'').trim();
        if(key) h['x-api-key']=key;
        return h;
      }
      async function post(path, body){
        const res = await fetch(base()+path,{method:'POST', headers:headers(), body: JSON.stringify(body||{})});
        const txt = await res.text();
        let j; try{ j = JSON.parse(txt); }catch{ j = { raw: txt }; }
        if(!res.ok){ throw new Error(JSON.stringify(j)); }
        return j;
      }
      function show(obj){ el('prodOut').textContent = JSON.stringify(obj, null, 2); }

      document.addEventListener('DOMContentLoaded', ()=>{
        const sku = el('prodSku'); const qty = el('prodQty');
        if (!sku.value) sku.value = localStorage.getItem('cmr_last_pt') || 'PT-CAPRESE-001';
        el('btnProduce').addEventListener('click', async ()=>{
          show({running:true});
          try {
            localStorage.setItem('cmr_last_pt', sku.value);
            const j = await post('/ops/produce', { sku: sku.value.trim(), qty: Number(qty.value||0) });
            show(j);
          } catch(e){
            show({error:String(e.message||e)});
          }
        });
      });
    })();
  </script>
